# ================================
# Builder stage: build all Python packages
# ================================
FROM python:3.11-slim as builder

LABEL maintainer="OPERANDI"

ENV PYTHONIOENCODING=utf8 \
    LC_ALL=C.UTF-8 \
    LANG=C.UTF-8 \
    DEBIAN_FRONTEND=noninteractive

# Install system build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
        build-essential \
        git \
        curl \
        make \
        wget \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /usr/src

# Copy and install utils first (for caching)
COPY utils/ ./utils
RUN python3 -m pip install --upgrade pip setuptools wheel \
    && pip wheel --no-deps --wheel-dir /wheels ./utils

# Copy and install broker
COPY broker/ ./broker
RUN pip wheel --no-deps --wheel-dir /wheels ./broker

# ================================
# Final stage: minimal runtime
# ================================
FROM python:3.11-slim

ENV PYTHONIOENCODING=utf8 \
    LC_ALL=C.UTF-8 \
    LANG=C.UTF-8

WORKDIR /usr/src

# Install runtime dependencies only (no build tools needed)
RUN apt-get update && apt-get install -y --no-install-recommends \
        git \
        curl \
    && rm -rf /var/lib/apt/lists/*

# Copy wheels from builder and install
COPY --from=builder /wheels /wheels
RUN python3 -m pip install --upgrade pip setuptools wheel \
    && pip install /wheels/*

# Copy broker code (optional if entry points are installed)
COPY broker/ ./broker
WORKDIR /usr/src/broker/operandi_broker

# Build success indicator
RUN echo "Operandi broker build success"

# Optional default command
CMD ["python3", "-m", "operandi_broker", "--version"]
