FROM ubuntu:22.04

LABEL org.opencontainers.image.authors="DFG OCR-D OPERANDI Project"
LABEL version="0.1"
LABEL description="This Dockerfile builds the OPERANDI Broker Server.\
The OPERANDI Broker is responsible for the processing, it dequeues jobs from the message queue, creates the workspace, stages the data to HPC, creates HPC jobs from the user prepared job description and starts/contoles the execution and updates the processing status. In the end the broker deliver processing results or updates the status for failed jobs in the task management.\
see https://github.com/subugoe/operandi"


ENV DEBIAN_FRONTEND noninteractive
ENV PYTHONIOENCODING utf8
ENV LC_ALL=C.UTF-8
ENV LANG=C.UTF-8

COPY ./service_broker/ /usr/src/service_broker
COPY ./rabbit_mq_utils/ /usr/src/rabbit_mq_utils

WORKDIR /usr/src/service_broker/service_broker

# install dependencies    
RUN apt-get update && apt-get -y install \
    git \
    curl \
    git  \
    make \
    python3 \
    python3-dev \
    python3-pip \
    python3-venv \
    sudo \
    time \
    wget  

RUN python3 -m pip install --upgrade pip setuptools
RUN pip3 install -U pip wheel
RUN python3 -m pip install -r /usr/src/service_broker/requirements.txt
RUN pip3 install /usr/src/service_broker
RUN python3 -m pip install -r /usr/src/rabbit_mq_utils/requirements.txt
RUN pip3 install /usr/src/rabbit_mq_utils

RUN echo "Operandi broker build success"
